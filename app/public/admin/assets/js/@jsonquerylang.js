const N=n=>Array.isArray(n),B=n=>typeof n=="string";function h(n){return(...t)=>{const e=t.map(c=>b(c)),r=e[0],s=e[1];return e.length===1?c=>n(r(c)):e.length===2?c=>n(r(c),s(c)):c=>n(...e.map(j=>j(c)))}}const A={pipe:(...n)=>{const t=n.map(e=>b(e));return e=>t.reduce((r,s)=>s(r),e)},object:n=>{const t=Object.keys(n).map(e=>[e,b(n[e])]);return e=>{const r={};for(const[s,c]of t)r[s]=c(e);return r}},array:(...n)=>{const t=n.map(e=>b(e));return e=>t.map(r=>r(e))},get:(...n)=>{if(n.length===0)return t=>t;if(n.length===1){const t=n[0];return e=>e==null?void 0:e[t]}return t=>{let e=t;for(const r of n)e=e==null?void 0:e[r];return e}},map:n=>{const t=b(n);return e=>e.map(t)},filter:n=>{const t=b(n);return e=>e.filter(t)},sort:(n=["get"],t)=>{const e=b(n),r=t==="desc"?-1:1;function s(c,j){const w=e(c),O=e(j);return w>O?r:w<O?-r:0}return c=>c.slice().sort(s)},pick:(...n)=>{const t=n.map(([r,...s])=>[s[s.length-1],A.get(...s)]),e=(r,s)=>{const c={};for(const[j,w]of s)c[j]=w(r);return c};return r=>N(r)?r.map(s=>e(s,t)):e(r,t)},groupBy:n=>{const t=b(n);return e=>{const r={};for(const s of e){const c=t(s);r[c]?r[c].push(s):r[c]=[s]}return r}},keyBy:n=>{const t=b(n);return e=>{var s;const r={};for(const c of e){const j=t(c);r[j]=(s=r[j])!=null?s:c}return r}},flatten:()=>n=>n.flat(),uniq:()=>n=>[...new Set(n)],uniqBy:n=>t=>Object.values(A.groupBy(n)(t)).map(e=>e[0]),limit:n=>t=>t.slice(0,n),size:()=>n=>n.length,keys:()=>Object.keys,values:()=>Object.values,prod:()=>n=>n.reduce((t,e)=>t*e),sum:()=>n=>n.reduce((t,e)=>t+e),average:()=>n=>A.sum()(n)/n.length,min:()=>n=>Math.min(...n),max:()=>n=>Math.max(...n),in:(n,t)=>{const e=b(n),r=b(t);return s=>r(s).includes(e(s))},"not in":(n,t)=>{const e=A.in(n,t);return r=>!e(r)},regex:(n,t,e)=>{const r=new RegExp(t,e),s=b(n);return c=>r.test(s(c))},and:h((n,t)=>n&&t),or:h((n,t)=>n||t),not:h(n=>!n),exists:h(n=>n!==void 0),eq:h((n,t)=>n===t),gt:h((n,t)=>n>t),gte:h((n,t)=>n>=t),lt:h((n,t)=>n<t),lte:h((n,t)=>n<=t),ne:h((n,t)=>n!==t),add:h((n,t)=>n+t),subtract:h((n,t)=>n-t),multiply:h((n,t)=>n*t),divide:h((n,t)=>n/t),pow:h((n,t)=>n**t),mod:h((n,t)=>n%t),abs:h(Math.abs),round:h((n,t=0)=>+"".concat(Math.round(+"".concat(n,"e").concat(t)),"e").concat(-t))},q=[];function b(n,t){q.unshift({...A,...q[0]});try{const e=N(n)?E(n,q[0]):()=>n;return r=>{var s;try{return e(r)}catch(c){throw c.jsonquery=[{data:r,query:n},...(s=c.jsonquery)!=null?s:[]],c}}}finally{q.shift()}}function E(n,t){const[e,...r]=n,s=t[e];if(!s)throw new Error("Unknown function '".concat(e,"'"));return s(...r)}const z={and:"and",or:"or",eq:"==",gt:">",gte:">=",lt:"<",lte:"<=",ne:"!=",add:"+",subtract:"-",multiply:"*",divide:"/",pow:"^",mod:"%",in:"in","not in":"not in"},M=/^[a-zA-Z_$][a-zA-Z\d_$]*$/,Z=/^[a-zA-Z_$][a-zA-Z\d_$]*/,U=/^"(?:[^"\\]|\\.)*"/,K=/^-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?/,P=/^(0|[1-9][0-9]*)/,R=/^(true|false|null)/,C=/^[ \n\t\r]+/;function D(n,t){const e=()=>{f();const u=r();if(f(),n[o]==="|"){const l=[u];for(;n[o]==="|";)o++,f(),l.push(r());return["pipe",...l]}return u},r=()=>{const u={...z},l=s();f();for(const g of Object.keys(u).sort((y,S)=>S.length-y.length)){const y=u[g];if(n.substring(o,o+y.length)===y){o+=y.length,f();const S=s();return[g,l,S]}}return l},s=()=>{if(n[o]==="("){o++;const u=e();return m(")"),u}return c()},c=()=>{var l,g,y;const u=[];if(n[o]==="."){for(;n[o]===".";)o++,u.push((y=(g=(l=a())!=null?l:i())!=null?g:p())!=null?y:$("Property expected"));return["get",...u]}return j()},j=()=>{const u=o,l=i();if(f(),!l||n[o]!=="(")return o=u,w();o++,!A[l]&&$("Unknown function '".concat(l,"'")),f();const g=n[o]!==")"?[e()]:[];for(;o<n.length&&n[o]!==")";)f(),m(","),g.push(e());return m(")"),[l,...g]},w=()=>{var u,l,g;if(n[o]==="{"){o++,f();const y={};let S=!0;for(;o<n.length&&n[o]!=="}";){S?S=!1:(m(","),f());const _=(g=(l=(u=a())!=null?u:i())!=null?l:p())!=null?g:$("Key expected");f(),m(":"),y[_]=e()}return m("}"),["object",y]}return O()},O=()=>{var u,l;if(n[o]==="["){o++,f();const g=[];let y=!0;for(;o<n.length&&n[o]!=="]";)y?y=!1:(m(","),f()),g.push(e());return m("]"),["array",...g]}return(l=(u=a())!=null?u:v())!=null?l:d()},a=()=>x(U,JSON.parse),i=()=>x(Z,u=>u),v=()=>x(K,JSON.parse),p=()=>x(P,JSON.parse),d=()=>{const u=x(R,JSON.parse);if(u!==void 0)return u;$("Value expected")},k=()=>{f(),o<n.length&&$("Unexpected part '".concat(n.substring(o),"'"))},x=(u,l)=>{const g=n.substring(o).match(u);if(g)return o+=g[0].length,l(g[0])},f=()=>x(C,u=>u),m=u=>{n[o]!==u&&$("Character '".concat(u,"' expected")),o++},$=(u,l=o)=>{throw new SyntaxError("".concat(u," (pos: ").concat(l,")"))};let o=0;const J=e();return k(),J}const F=40,I="  ",L=(n,t)=>{const e=I,r=(a,i)=>N(a)?s(a,i):JSON.stringify(a),s=(a,i)=>{var m;var v;const[p,...d]=a;if(p==="get"&&d.length>0)return j(d);if(p==="pipe"){const $=d.map(o=>r(o,i+e));return O($,[""," | ",""],["","\n".concat(i+e,"| "),""])}if(p==="object")return c(d[0],i);if(p==="array"){const $=d.map(o=>r(o,i));return O($,["[",", ","]"],["[\n".concat(i+e),",\n".concat(i+e),"\n".concat(i,"]")])}const k=(m=(v=void 0)==null?void 0:v[p])!=null?m:z[p];if(k&&d.length===2){const[$,o]=d,J=r($,i),u=r(o,i);return"(".concat(J," ").concat(k," ").concat(u,")")}const x=d.length===1?i:i+e,f=d.map($=>r($,x));return d.length===1&&f[0][0]==="("?"".concat(p).concat(f):O(f,["".concat(p,"("),", ",")"],d.length===1?["".concat(p,"("),",\n".concat(i),")"]:["".concat(p,"(\n").concat(x),",\n".concat(x),"\n".concat(i,")")])},c=(a,i)=>{const v=i+e,p=Object.entries(a).map(([d,k])=>"".concat(w(d),": ").concat(r(k,v)));return O(p,["{ ",", "," }"],["{\n".concat(v),",\n".concat(v),"\n".concat(i,"}")])},j=a=>a.map(i=>".".concat(w(i))).join(""),w=a=>M.test(a)?a:JSON.stringify(a),O=(a,[i,v,p],[d,k,x])=>i.length+a.reduce((f,m)=>f+m.length+v.length,0)-v.length+p.length<=F?i+a.join(v)+p:d+a.join(k)+x;return r(n,"")};function T(n,t,e){return b(B(t)?D(t):t)(n)}export{L as D,T as K,D as M};
