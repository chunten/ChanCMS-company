const defaultKeyWords = [
  "\\.(php|asp|aspx|jsp|jspx|cgi|pl|sh|bat|exe|sql|rar|gz|tar|tgz|7z|json|xml|vscode|bak|well-known)",
  "admin",
  "union\\s+select",
  "drop\\s+table",
  "delete\\s+from",
  "insert\\s+into",
  "update\\s+set",
  "exec\\s+\\(",
  "script",
  "alert",
  "iframe",
  "onerror",
  "confirm",
  "prompt",
  "eval",
  "document\\.cookie",
  "window\\.location",
  "fetch",
  "xhr",
  "ajax",
  "data",
  "root",
  "backup",
  "callback",
  "ftp"
];

// 关键词检查方法
const checkKeywords = (url, keywords) => {
  const allKeywords = [...defaultKeyWords, ...keywords];
  const keywordReg = new RegExp(allKeywords.join("|"), "i");
  return keywordReg.test(url);
};

// 防止点击劫持方法
const setXFrameOptions = (res, frameOption) => {
  const options = {
    DENY: "DENY",
    SAMEORIGIN: "SAMEORIGIN",
    "ALLOW-FROM": `ALLOW-FROM ${frameOption}`,
  };
  res.set("X-Frame-Options", options[frameOption] || "SAMEORIGIN");
};

// 安全中间件
const safe = (options) => {
  const params = { 
    keywords: [],
    sendText: "未知请求，已阻止...",
    frameOption: "SAMEORIGIN",
    ...options 
  };

  return (req, res, next) => {

    // 设置 X-Frame-Options
    setXFrameOptions(res, params.frameOption);

    // 关键词检查
    if (checkKeywords(req.url, params.keywords)) {
      console.error(`疑似攻击: ${req.url}`);
      return res.status(403).send(params.sendText);
    }
    
    next();
  };
};

module.exports = safe;